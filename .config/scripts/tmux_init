#!/usr/bin/env bash

set -euo pipefail

expand_path() {
    local p="$1"
    case "$p" in
        "~"*) p="$HOME${p:1}";;
    esac
    echo "${p%/}"
}

TMUX_BIN="$(command -v tmux)"
[[ -z "$TMUX_BIN" ]] && { echo "Error: tmux not found"; exit 1; }

tmux_create_window() {
    local session_name="$1"
    local path="$(expand_path "$2")"
    local window_name="${path##*/}"
    [[ -z "$window_name" ]] && window_name="default"
    "$TMUX_BIN" new-window -t "${session_name}:" -c "$path" -n "$window_name" -d
}

tmux_create_session() {
    local session_name="$1"
    shift

    (( $# == 0 )) && { echo "No paths for $session_name"; return; }

    "$TMUX_BIN" has-session -t "$session_name" 2>/dev/null && return

    local first_path="$(expand_path "$1")"
    local first_window="${first_path##*/}"
    [[ -z "$first_window" ]] && first_window="default"

    "$TMUX_BIN" new-session -d -s "$session_name" -c "$first_path" -n "$first_window"
    shift

    for path in "$@"; do
        tmux_create_window "$session_name" "$path"
    done
}

tmux_attach_session() {
    local session_name="$1"
    exec "$TMUX_BIN" attach-session -t "$session_name"
}

tmux_init() {
    local debug=0
    local default_session=""

    while getopts "d" opt; do
        [[ "$opt" == "d" ]] && debug=1
    done
    shift $((OPTIND - 1))
    [[ $# -gt 0 ]] && default_session="$1"
    DEBUG=$debug

    local json_file="$HOME/.tmux-sessions.json"
    [[ ! -f "$json_file" ]] && { echo "No JSON: $json_file"; exit 1; }

    command -v jq >/dev/null || { echo "jq missing"; exit 1; }

    mapfile -t session_names < <(jq -r 'keys_unsorted[]' "$json_file")

    (( ${#session_names[@]} == 0 )) && { echo "Empty JSON"; exit 1; }

    for session_name in "${session_names[@]}"; do
        mapfile -t session_paths < <(jq -r --arg key "$session_name" '.[$key][]' "$json_file")
        tmux_create_session "$session_name" "${session_paths[@]}"
    done

    tmux_attach_session "${default_session:-${session_names[0]}}"
}

tmux_init "$@"
